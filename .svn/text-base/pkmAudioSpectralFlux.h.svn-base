/*
 *  pkmAudioSpectralFlux.h
 *  avSaliency
 *
 *  Created by Mr. Magoo on 8/30/11.
 *  Copyright 2011 __MyCompanyName__. All rights reserved.
 *
 */

#pragma once

#include "pkmSTFT.h"
#include "pkmMatrix.h"

class pkmAudioSpectralFlux
{
public:
    pkmAudioSpectralFlux(int fS = 512)
    {
        bInit = false;
        frameSize = fS;
        stft = new pkmSTFT(frameSize);
    }
    ~pkmAudioSpectralFlux()
    {
        delete stft;
    }
    
    float getFlux(float *frame)
    {
        stft->STFT(frame, frameSize, cMagnitudes, phases);
        //cMagnitudes.normalizeRow(0);
        if (bInit) {
            flux = pkm::Mat::sumOfAbsoluteDifferences(cMagnitudes.data, pMagnitudes.data, frameSize);
            std::swap(cMagnitudes.data, pMagnitudes.data);
        }
        else {
            flux = 0;
            pMagnitudes = cMagnitudes;
            bInit = true;
        }
        
        return flux;
    }
    
    pkmSTFT *stft;
    float flux;
    pkm::Mat pMagnitudes, cMagnitudes, fMagnitudes, phases;
    int frameSize;
    bool bInit;
};